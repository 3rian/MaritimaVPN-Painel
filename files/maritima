#!/usr/bin/env bash
export TERM=xterm
set +e

# ---------- CORES ----------
CYAN='\033[1;36m'
BLUE='\033[1;34m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
PURPLE='\033[1;35m'
WHITE='\033[1;37m'
GRAY='\033[1;90m'
BLACK='\033[1;30m'
NC='\033[0m'

# Cores para banner
BANNER_CYAN='\033[1;96m'
BANNER_BLUE='\033[1;94m'
BANNER_GREEN='\033[1;92m'
BANNER_YELLOW='\033[1;93m'
BANNER_RED='\033[1;91m'
LINE_COLOR='\033[1;90m'

BASE="/opt/maritima"
DB="$BASE/users.db"
BANNER="$BASE/banner.txt"
LOG_FILE="$BASE/login_attempts.log"
mkdir -p "$BASE"
touch "$DB" "$BANNER" "$LOG_FILE"

pause() { 
    echo
    read -rp "ENTER para continuar..." 
    echo
}

get_ip() {
  ip=$(curl -s --max-time 3 ifconfig.me || true)
  [[ -z "$ip" ]] && ip="IP-INDEFINIDO"
  echo "$ip"
}

service_status() {
  systemctl is-active "$1" &>/dev/null && \
  echo -e "${BANNER_GREEN}â— ATIVO${NC}" || echo -e "${RED}â— OFF${NC}"
}

# ================== FUNÃ‡Ã•ES DE EXPIRAÃ‡ÃƒO ==================

# Calcula dias restantes - FUNÃ‡ÃƒO SIMPLIFICADA
calculate_days_left() {
    local exp_date="$1"
    
    if [[ "$exp_date" == "NUNCA" ]]; then
        echo "âˆ"
        return
    fi
    
    if [[ "$exp_date" == "TESTE" ]]; then
        echo "TESTE"
        return
    fi
    
    # Para datas no formato YYYY-MM-DD
    if [[ "$exp_date" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        local today=$(date +%Y-%m-%d)
        local exp_seconds=$(date -d "$exp_date" +%s 2>/dev/null || echo 0)
        local today_seconds=$(date -d "$today" +%s 2>/dev/null || echo 0)
        
        if [[ $exp_seconds -eq 0 ]] || [[ $today_seconds -eq 0 ]]; then
            echo "ERRO"
            return
        fi
        
        local diff=$(( (exp_seconds - today_seconds) / 86400 ))
        
        if [[ $diff -lt 0 ]]; then
            echo "0"
        else
            echo "$diff"
        fi
        return
    fi
    
    # Para data/hora TESTE
    if [[ "$exp_date" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}\ [0-9]{2}:[0-9]{2}$ ]]; then
        local now_seconds=$(date +%s)
        local exp_seconds=$(date -d "$exp_date" +%s 2>/dev/null || echo 0)
        
        if [[ $exp_seconds -eq 0 ]]; then
            echo "ERRO"
            return
        fi
        
        local diff=$(( (exp_seconds - now_seconds) / 60 ))
        
        if [[ $diff -le 0 ]]; then
            echo "0"
        elif [[ $diff -lt 60 ]]; then
            echo "${diff}m"
        elif [[ $diff -lt 1440 ]]; then
            echo "$((diff/60))h"
        else
            echo "$((diff/1440))d"
        fi
        return
    fi
    
    echo "?"
}

# Verifica se usuÃ¡rio existe no banco de dados
user_exists_in_db() {
    local user="$1"
    grep -q "^$user:" "$DB" 2>/dev/null
    return $?
}

# Limpa usuÃ¡rios expirados - VERSÃƒO SIMPLIFICADA
cleanup_expired_users() {
    if [[ ! -f "$DB" ]] || [[ ! -s "$DB" ]]; then
        return 0
    fi
    
    local today=$(date +%Y-%m-%d)
    local temp_file="${DB}.temp"
    
    > "$temp_file"
    
    while IFS=: read -r u p e l uuid; do
        # Pular linhas vazias
        [[ -z "$u" ]] && continue
        
        # Verificar se Ã© TESTE com data/hora
        if [[ "$e" == "TESTE" ]] && [[ "$uuid" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}\ [0-9]{2}:[0-9]{2}$ ]]; then
            local exp_seconds=$(date -d "$uuid" +%s 2>/dev/null || echo 0)
            local now_seconds=$(date +%s)
            
            if [[ $exp_seconds -gt 0 ]] && [[ $now_seconds -ge $exp_seconds ]]; then
                echo "$(date '+%Y-%m-%d %H:%M:%S') - Removendo TESTE expirado: $u" >> "$LOG_FILE"
                userdel "$u" 2>/dev/null
                pkill -u "$u" 2>/dev/null
                continue
            fi
        # Verificar data normal
        elif [[ "$e" != "NUNCA" ]] && [[ "$e" != "TESTE" ]]; then
            if [[ "$e" < "$today" ]]; then
                echo "$(date '+%Y-%m-%d %H:%M:%S') - Removendo expirado: $u (exp: $e)" >> "$LOG_FILE"
                userdel "$u" 2>/dev/null
                pkill -u "$u" 2>/dev/null
                continue
            fi
        fi
        
        # Manter usuÃ¡rio
        echo "$u:$p:$e:$l:$uuid" >> "$temp_file"
        
    done < "$DB"
    
    # Substituir arquivo original se houver mudanÃ§as
    if [[ -s "$temp_file" ]]; then
        mv "$temp_file" "$DB"
    else
        > "$DB"
        rm -f "$temp_file"
    fi
}

# ================= STATUS VPS =================
status_vps() {
    cleanup_expired_users
    clear
    echo -e "${BANNER_CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BANNER_CYAN}â•‘${NC}        ${BANNER_YELLOW}ğŸ´â€â˜ ï¸ MARÃTIMA VPN STATUS${NC}        ${BANNER_CYAN}â•‘${NC}"
    echo -e "${BANNER_CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${NC}"
    echo -e " ${BANNER_YELLOW}ğŸŒ${NC} IP VPS   : ${BANNER_GREEN}$(get_ip)${NC}"
    echo -e " ${BANNER_YELLOW}â±ï¸${NC} Uptime  : ${BANNER_YELLOW}$(uptime -p)${NC}"
    echo -e " ${BANNER_YELLOW}ğŸ§ ${NC} RAM     : ${BANNER_BLUE}$(free -m | awk '/Mem:/ {print $3 "/" $2 " MB"}')${NC}"
    echo -e " ${BANNER_YELLOW}ğŸ’½${NC} Disco   : ${BANNER_BLUE}$(df -h / | awk 'NR==2 {print $3 "/" $2}')${NC}"
    echo -e " ${BANNER_YELLOW}ğŸŒ${NC} WebSocket SSH : $(service_status maritima-ws)"
    echo -e " ${BANNER_YELLOW}ğŸ”${NC} XRAY REALITY  : $(service_status xray)"
    echo -e " ${BANNER_YELLOW}ğŸ®${NC} BadVPN UDP    : $(service_status maritima-badvpn)"
    echo -e " ${BANNER_YELLOW}ğŸŒ${NC} HTTP Proxy Banner : $(service_status maritima-http)"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    pause
}

# ================= USUÃRIOS =================
add_user() {
    while true; do
        clear
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${CYAN}ğŸ“ CRIAR NOVO USUÃRIO${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}[0] Voltar${NC}"
        echo
        
        read -rp "Login: " u
        [[ "$u" == "0" ]] && return 0
        [[ -z "$u" ]] && { echo -e "${RED}Login nÃ£o pode ser vazio${NC}"; sleep 2; continue; }
        
        if id "$u" &>/dev/null || user_exists_in_db "$u"; then
            echo -e "${RED}UsuÃ¡rio jÃ¡ existe${NC}"
            sleep 2
            continue
        fi
        
        read -rp "Senha: " p
        [[ "$p" == "0" ]] && return 0
        [[ -z "$p" ]] && { echo -e "${RED}Senha nÃ£o pode ser vazia${NC}"; sleep 2; continue; }
        
        read -rp "Dias (0=vitalÃ­cio): " d
        [[ "$d" == "0" ]] && return 0
        
        if ! [[ "$d" =~ ^[0-9]+$ ]]; then
            echo -e "${RED}Digite um nÃºmero vÃ¡lido${NC}"
            sleep 2
            continue
        fi
        
        read -rp "Limite conexÃµes (1-999): " l
        [[ "$l" == "0" ]] && return 0
        
        if ! [[ "$l" =~ ^[0-9]+$ ]] || [[ "$l" -lt 1 ]] || [[ "$l" -gt 999 ]]; then
            echo -e "${RED}Limite invÃ¡lido (1-999)${NC}"
            sleep 2
            continue
        fi
        
        # Criar usuÃ¡rio no sistema
        if useradd -M -s /bin/false "$u" 2>/dev/null; then
            echo "$u:$p" | chpasswd
            echo -e "${GREEN}âœ… UsuÃ¡rio criado no sistema${NC}"
        else
            echo -e "${RED}Erro ao criar usuÃ¡rio no sistema${NC}"
            sleep 2
            continue
        fi
        
        # Definir data de expiraÃ§Ã£o
        if [[ "$d" == "0" ]]; then
            EXP="NUNCA"
        else
            EXP=$(date -d "+$d days" +%Y-%m-%d 2>/dev/null)
            if [[ -z "$EXP" ]]; then
                EXP=$(date +%Y-%m-%d -d "+$d days")
            fi
        fi
        
        UUID=$(cat /proc/sys/kernel/random/uuid 2>/dev/null || echo "$(date +%s)$RANDOM")
        
        # Adicionar ao banco de dados
        echo "$u:$p:$EXP:$l:$UUID" >> "$DB"
        
        clear
        echo -e "${BANNER_GREEN}âœ… USUÃRIO CRIADO COM SUCESSO!${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "ğŸ‘¤ ${GREEN}Login: $u${NC}"
        echo -e "ğŸ”‘ ${YELLOW}Senha: $p${NC}"
        echo -e "ğŸ“… ${WHITE}Expira: $EXP${NC}"
        echo -e "ğŸ“¶ ${WHITE}Limite: $l conexÃµes${NC}"
        if [[ "$d" != "0" ]]; then
            echo -e "â³ ${GREEN}Dias restantes: $d${NC}"
        fi
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        
        echo
        read -rp "Criar outro usuÃ¡rio? (s/n): " resp
        [[ "$resp" != "s" ]] && break
    done
}

# FUNÃ‡ÃƒO LIST_USERS CORRIGIDA
list_users() {
    
    
    clear
    echo -e "${CYAN}${BOLD}ğŸ‘¥ USUÃRIOS CADASTRADOS${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    # Verificar se o arquivo existe e tem conteÃºdo
    if [[ ! -f "$DB" ]]; then
        echo -e "${YELLOW}Arquivo de banco de dados nÃ£o encontrado${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        pause
        return
    fi
    
    if [[ ! -s "$DB" ]]; then
        echo -e "${YELLOW}Nenhum usuÃ¡rio cadastrado${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        pause
        return
    fi
    
    IP=$(get_ip)
    TOTAL=0
    ATIVOS=0
    EXPIRADOS=0
    TESTES=0
    
    # Ler o arquivo linha por linha de forma segura
    while IFS= read -r line || [[ -n "$line" ]]; do
        # Ignorar linhas vazias
        [[ -z "$line" ]] && continue
        
        # Separar os campos
        IFS=: read -r u p e l uuid <<< "$line"
        
        # Verificar se temos todos os campos
        if [[ -z "$u" ]] || [[ -z "$p" ]] || [[ -z "$e" ]]; then
            continue
        fi
        
        ((TOTAL++))
        
        # Calcular dias restantes
        DAYS_LEFT=$(calculate_days_left "$e")
        
        # Determinar status
        if [[ "$e" == "NUNCA" ]]; then
            STATUS_ICON="âœ…"
            STATUS_COLOR="$GREEN"
            STATUS_TEXT="VITALÃCIO"
            ((ATIVOS++))
        elif [[ "$e" == "TESTE" ]]; then
            STATUS_ICON="ğŸ§ª"
            STATUS_COLOR="$YELLOW"
            if [[ "$uuid" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}\ [0-9]{2}:[0-9]{2}$ ]]; then
                STATUS_TEXT="TESTE ($DAYS_LEFT)"
            else
                STATUS_TEXT="TESTE"
            fi
            ((TESTES++))
        else
            if [[ "$DAYS_LEFT" == "0" ]] || [[ "$DAYS_LEFT" == "ERRO" ]]; then
                STATUS_ICON="âŒ"
                STATUS_COLOR="$RED"
                STATUS_TEXT="EXPIRADO"
                ((EXPIRADOS++))
            else
                STATUS_ICON="âœ…"
                STATUS_COLOR="$GREEN"
                STATUS_TEXT="$DAYS_LEFT dias"
                ((ATIVOS++))
            fi
        fi
        
        # Mostrar informaÃ§Ãµes do usuÃ¡rio
        echo -e "${STATUS_ICON} ${GREEN}$u${NC}"
        echo -e "   ğŸ”‘ ${YELLOW}$p${NC}"
        echo -e "   ğŸ“… ${STATUS_COLOR}$e${NC}"
        echo -e "   â³ ${STATUS_COLOR}$STATUS_TEXT${NC}"
        echo -e "   ğŸ“¶ Limite: ${WHITE}$l${NC}"
        echo -e "   ğŸŒ ${GRAY}ssh://$u:$p@$IP:22${NC}"
        echo -e "${LINE_COLOR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        
    done < "$DB"
    
    # Mostrar resumo
    echo -e "${BANNER_CYAN}ğŸ“Š RESUMO:${NC}"
    echo -e "   ${GREEN}âœ… Ativos: $ATIVOS${NC}"
    echo -e "   ${YELLOW}ğŸ§ª Testes: $TESTES${NC}"
    echo -e "   ${RED}âŒ Expirados: $EXPIRADOS${NC}"
    echo -e "   ${WHITE}ğŸ“Š Total: $TOTAL${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    pause
}

# FunÃ§Ã£o para mostrar menu de seleÃ§Ã£o de usuÃ¡rios
show_user_menu() {
    local title="$1"
    
    clear
    echo -e "${CYAN}${BOLD}$title${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    if [[ ! -f "$DB" ]] || [[ ! -s "$DB" ]]; then
        echo -e "${YELLOW}Nenhum usuÃ¡rio cadastrado${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        return 1
    fi
    
    local i=1
    declare -A USERS
    
    while IFS= read -r line || [[ -n "$line" ]]; do
        [[ -z "$line" ]] && continue
        IFS=: read -r u p e l uuid <<< "$line"
        [[ -z "$u" ]] && continue
        
        DAYS_LEFT=$(calculate_days_left "$e")
        STATUS="${WHITE}$e${NC}"
        
        if [[ "$e" != "NUNCA" && "$e" != "TESTE" ]]; then
            if [[ "$DAYS_LEFT" == "0" ]] || [[ "$DAYS_LEFT" == "ERRO" ]]; then
                STATUS="${RED}$e (EXPIRADO)${NC}"
            fi
        fi
        
        echo -e "${YELLOW}[$i]${NC} ${GREEN}$u${NC} ${GRAY}($STATUS)${NC}"
        USERS[$i]="$u"
        ((i++))
    done < "$DB"
    
    echo -e "${YELLOW}[0]${NC} ${WHITE}Voltar${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    # Retornar o array de usuÃ¡rios
    declare -p USERS 2>/dev/null || echo ""
    return 0
}

change_limit() {
    while true; do
        eval "$(show_user_menu "ğŸ“¶ ALTERAR LIMITE DE CONEXÃ•ES")"
        [[ $? -eq 1 ]] && { pause; return; }
        
        echo
        read -rp "Selecione o usuÃ¡rio: " opt
        
        [[ "$opt" == "0" ]] && return
        
        if ! [[ "$opt" =~ ^[0-9]+$ ]]; then
            echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}"
            sleep 2
            continue
        fi
        
        USER="${USERS[$opt]}"
        
        if [[ -z "$USER" ]]; then
            echo -e "${RED}UsuÃ¡rio invÃ¡lido${NC}"
            sleep 2
            continue
        fi
        
        # Buscar dados atuais
        LINE=$(grep "^$USER:" "$DB")
        if [[ -z "$LINE" ]]; then
            echo -e "${RED}UsuÃ¡rio nÃ£o encontrado no banco de dados${NC}"
            sleep 2
            continue
        fi
        
        IFS=: read -r u p e l uuid <<< "$LINE"
        
        echo
        echo -e "UsuÃ¡rio: ${GREEN}$u${NC}"
        echo -e "Limite atual: ${YELLOW}$l${NC}"
        echo
        
        read -rp "Novo limite (1-999): " NEW_LIMIT
        [[ "$NEW_LIMIT" == "0" ]] && continue
        
        if ! [[ "$NEW_LIMIT" =~ ^[0-9]+$ ]] || [[ "$NEW_LIMIT" -lt 1 ]] || [[ "$NEW_LIMIT" -gt 999 ]]; then
            echo -e "${RED}Limite invÃ¡lido (1-999)${NC}"
            sleep 2
            continue
        fi
        
        # Atualizar no banco de dados
        sed -i "s|^$u:.*|$u:$p:$e:$NEW_LIMIT:$uuid|" "$DB"
        
        echo -e "${GREEN}âœ… Limite alterado para $NEW_LIMIT conexÃµes${NC}"
        sleep 2
        
        echo
        read -rp "Alterar outro limite? (s/n): " resp
        [[ "$resp" != "s" ]] && break
    done
}

change_password() {
    while true; do
        eval "$(show_user_menu "ğŸ”‘ ALTERAR SENHA DO USUÃRIO")"
        [[ $? -eq 1 ]] && { pause; return; }
        
        echo
        read -rp "Selecione o usuÃ¡rio: " opt
        
        [[ "$opt" == "0" ]] && return
        
        if ! [[ "$opt" =~ ^[0-9]+$ ]]; then
            echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}"
            sleep 2
            continue
        fi
        
        USER="${USERS[$opt]}"
        
        if [[ -z "$USER" ]]; then
            echo -e "${RED}UsuÃ¡rio invÃ¡lido${NC}"
            sleep 2
            continue
        fi
        
        # Buscar dados atuais
        LINE=$(grep "^$USER:" "$DB")
        if [[ -z "$LINE" ]]; then
            echo -e "${RED}UsuÃ¡rio nÃ£o encontrado no banco de dados${NC}"
            sleep 2
            continue
        fi
        
        IFS=: read -r u p e l uuid <<< "$LINE"
        
        echo
        echo -e "UsuÃ¡rio: ${GREEN}$u${NC}"
        echo
        
        read -rp "Nova senha: " PASS1
        [[ "$PASS1" == "0" ]] && continue
        
        if [[ -z "$PASS1" ]] || [[ ${#PASS1} -lt 4 ]]; then
            echo -e "${RED}Senha muito curta (mÃ­nimo 4 caracteres)${NC}"
            sleep 2
            continue
        fi
        
        read -rp "Confirmar senha: " PASS2
        
        if [[ "$PASS1" != "$PASS2" ]]; then
            echo -e "${RED}Senhas nÃ£o conferem${NC}"
            sleep 2
            continue
        fi
        
        # Alterar senha no sistema
        if echo "$USER:$PASS1" | chpasswd 2>/dev/null; then
            echo -e "${GREEN}âœ… Senha alterada no sistema${NC}"
        else
            echo -e "${RED}Erro ao alterar senha no sistema${NC}"
            sleep 2
            continue
        fi
        
        # Atualizar no banco de dados
        sed -i "s|^$u:.*|$u:$PASS1:$e:$l:$uuid|" "$DB"
        
        # Derrubar conexÃµes ativas
        pkill -u "$USER" 2>/dev/null && echo -e "${YELLOW}ConexÃµes ativas derrubadas${NC}"
        
        echo -e "${GREEN}âœ… Senha alterada com sucesso${NC}"
        sleep 2
        
        echo
        read -rp "Alterar outra senha? (s/n): " resp
        [[ "$resp" != "s" ]] && break
    done
}

del_user() {
    while true; do
        clear
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${RED}ğŸ—‘ï¸ REMOVER USUÃRIO${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}[0] Voltar${NC}"
        echo
        
        read -rp "Nome do usuÃ¡rio: " u
        [[ "$u" == "0" ]] && return
        
        if [[ -z "$u" ]]; then
            echo -e "${RED}Digite um nome de usuÃ¡rio${NC}"
            sleep 2
            continue
        fi
        
        # Verificar se existe
        if ! id "$u" &>/dev/null && ! user_exists_in_db "$u"; then
            echo -e "${YELLOW}UsuÃ¡rio nÃ£o encontrado${NC}"
            sleep 2
            continue
        fi
        
        echo
        read -rp "Tem certeza que deseja remover '$u'? (s/n): " confirm
        
        if [[ "$confirm" == "s" ]]; then
            # Remover do sistema
            userdel "$u" 2>/dev/null && echo -e "${GREEN}âœ… UsuÃ¡rio removido do sistema${NC}"
            
            # Derrubar conexÃµes
            pkill -u "$u" 2>/dev/null && echo -e "${YELLOW}ConexÃµes ativas derrubadas${NC}"
            
            # Remover do banco de dados
            if sed -i "/^$u:/d" "$DB" 2>/dev/null; then
                echo -e "${GREEN}âœ… UsuÃ¡rio removido do banco de dados${NC}"
            fi
            
            echo -e "${BANNER_GREEN}âœ… UsuÃ¡rio completamente removido${NC}"
        else
            echo -e "${YELLOW}OperaÃ§Ã£o cancelada${NC}"
        fi
        
        sleep 2
        
        echo
        read -rp "Remover outro usuÃ¡rio? (s/n): " resp
        [[ "$resp" != "s" ]] && break
    done
}

change_expiration() {
    while true; do
        eval "$(show_user_menu "ğŸ“… ALTERAR DATA DE EXPIRAÃ‡ÃƒO")"
        [[ $? -eq 1 ]] && { pause; return; }
        
        echo
        read -rp "Selecione o usuÃ¡rio: " opt
        
        [[ "$opt" == "0" ]] && return
        
        if ! [[ "$opt" =~ ^[0-9]+$ ]]; then
            echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}"
            sleep 2
            continue
        fi
        
        USER="${USERS[$opt]}"
        
        if [[ -z "$USER" ]]; then
            echo -e "${RED}UsuÃ¡rio invÃ¡lido${NC}"
            sleep 2
            continue
        fi
        
        # Buscar dados atuais
        LINE=$(grep "^$USER:" "$DB")
        if [[ -z "$LINE" ]]; then
            echo -e "${RED}UsuÃ¡rio nÃ£o encontrado no banco de dados${NC}"
            sleep 2
            continue
        fi
        
        IFS=: read -r u p e l uuid <<< "$LINE"
        
        clear
        echo -e "${CYAN}${BOLD}ğŸ“… ALTERAR DATA DE EXPIRAÃ‡ÃƒO${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "ğŸ‘¤ UsuÃ¡rio: ${GREEN}$u${NC}"
        echo -e "ğŸ“… Data atual: ${YELLOW}$e${NC}"
        
        DAYS_LEFT=$(calculate_days_left "$e")
        echo -e "â³ Dias restantes: ${GREEN}$DAYS_LEFT${NC}"
        
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}OpÃ§Ãµes:${NC}"
        echo -e "  ${WHITE}30${NC}           â†’ adiciona 30 dias"
        echo -e "  ${WHITE}25/12/2026${NC}  â†’ data fixa (DD/MM/AAAA)"
        echo -e "  ${WHITE}0${NC}            â†’ vitalÃ­cio"
        echo -e "  ${WHITE}teste 60${NC}    â†’ teste por 60 minutos"
        echo -e "  ${WHITE}cancelar${NC}    â†’ voltar"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo
        
        read -rp "Nova data ou dias: " INPUT
        [[ "$INPUT" == "cancelar" ]] && continue
        
        # Processar entrada
        if [[ "$INPUT" == "0" ]]; then
            NEW_EXP="NUNCA"
            NEW_UUID=$(cat /proc/sys/kernel/random/uuid 2>/dev/null || echo "$(date +%s)$RANDOM")
            
        elif [[ "$INPUT" =~ ^[Tt][Ee][Ss][Tt][Ee]\ [0-9]+$ ]]; then
            MINUTES=$(echo "$INPUT" | awk '{print $2}')
            NEW_EXP="TESTE"
            NEW_UUID=$(date -d "+$MINUTES minutes" +"%Y-%m-%d %H:%M")
            
        elif [[ "$INPUT" =~ ^[0-9]+$ ]]; then
            # Adicionar dias
            if [[ "$e" == "NUNCA" ]] || [[ "$e" == "TESTE" ]]; then
                # ComeÃ§ar do dia atual
                NEW_EXP=$(date -d "+$INPUT days" +%Y-%m-%d)
            else
                # Adicionar Ã  data atual de expiraÃ§Ã£o
                if [[ "$e" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
                    NEW_EXP=$(date -d "$e +$INPUT days" +%Y-%m-%d 2>/dev/null)
                fi
                if [[ -z "$NEW_EXP" ]]; then
                    NEW_EXP=$(date -d "+$INPUT days" +%Y-%m-%d)
                fi
            fi
            NEW_UUID=$(cat /proc/sys/kernel/random/uuid 2>/dev/null || echo "$(date +%s)$RANDOM")
            
        elif [[ "$INPUT" =~ ^[0-9]{2}/[0-9]{2}/[0-9]{4}$ ]]; then
            # Data fixa DD/MM/AAAA
            DAY=$(echo "$INPUT" | cut -d'/' -f1)
            MONTH=$(echo "$INPUT" | cut -d'/' -f2)
            YEAR=$(echo "$INPUT" | cut -d'/' -f3)
            NEW_EXP="$YEAR-$MONTH-$DAY"
            NEW_UUID=$(cat /proc/sys/kernel/random/uuid 2>/dev/null || echo "$(date +%s)$RANDOM")
            
        else
            echo -e "${RED}Formato invÃ¡lido${NC}"
            sleep 2
            continue
        fi
        
        # Validar data
        if [[ "$NEW_EXP" != "NUNCA" ]] && [[ "$NEW_EXP" != "TESTE" ]]; then
            if ! date -d "$NEW_EXP" &>/dev/null; then
                echo -e "${RED}Data invÃ¡lida${NC}"
                sleep 2
                continue
            fi
        fi
        
        # Atualizar banco de dados
        sed -i "s|^$u:.*|$u:$p:$NEW_EXP:$l:$NEW_UUID|" "$DB"
        
        # Se estava expirado e agora nÃ£o estÃ¡, reativar
        if [[ "$e" != "NUNCA" ]] && [[ "$e" != "TESTE" ]] && [[ "$(calculate_days_left "$e")" == "0" ]]; then
            echo "$u:$p" | chpasswd 2>/dev/null && echo -e "${GREEN}âœ… UsuÃ¡rio reativado${NC}"
        fi
        
        clear
        echo -e "${BANNER_GREEN}âœ… DATA ALTERADA COM SUCESSO${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "ğŸ‘¤ UsuÃ¡rio: ${GREEN}$u${NC}"
        echo -e "ğŸ“… Nova data: ${YELLOW}$NEW_EXP${NC}"
        
        NEW_DAYS=$(calculate_days_left "$NEW_EXP")
        echo -e "â³ Dias restantes: ${BANNER_GREEN}$NEW_DAYS${NC}"
        
        if [[ "$NEW_EXP" == "TESTE" ]]; then
            echo -e "â±ï¸  Tipo: ${YELLOW}CONTA TESTE${NC}"
        elif [[ "$NEW_EXP" == "NUNCA" ]]; then
            echo -e "â­ Tipo: ${BANNER_CYAN}VITALÃCIO${NC}"
        fi
        
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        
        sleep 3
        
        echo
        read -rp "Alterar outra data? (s/n): " resp
        [[ "$resp" != "s" ]] && break
    done
}

add_test_user() {
    while true; do
        clear
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${CYAN}ğŸ§ª CRIAR USUÃRIO TESTE${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}[0] Voltar${NC}"
        echo
        
        read -rp "Login teste: " u
        [[ "$u" == "0" ]] && return
        
        if [[ -z "$u" ]]; then
            echo -e "${RED}Login nÃ£o pode ser vazio${NC}"
            sleep 2
            continue
        fi
        
        if id "$u" &>/dev/null || user_exists_in_db "$u"; then
            echo -e "${RED}UsuÃ¡rio jÃ¡ existe${NC}"
            sleep 2
            continue
        fi
        
        read -rp "Senha: " p
        [[ "$p" == "0" ]] && return
        
        if [[ -z "$p" ]]; then
            echo -e "${RED}Senha nÃ£o pode ser vazia${NC}"
            sleep 2
            continue
        fi
        
        read -rp "Limite conexÃµes (1-999): " l
        [[ "$l" == "0" ]] && return
        
        if ! [[ "$l" =~ ^[0-9]+$ ]] || [[ "$l" -lt 1 ]] || [[ "$l" -gt 999 ]]; then
            echo -e "${RED}Limite invÃ¡lido (1-999)${NC}"
            sleep 2
            continue
        fi
        
        read -rp "Validade (minutos): " m
        [[ "$m" == "0" ]] && return
        
        if ! [[ "$m" =~ ^[0-9]+$ ]] || [[ "$m" -lt 1 ]]; then
            echo -e "${RED}Tempo invÃ¡lido (mÃ­nimo 1 minuto)${NC}"
            sleep 2
            continue
        fi
        
        # Criar usuÃ¡rio
        if useradd -M -s /bin/false "$u" 2>/dev/null; then
            echo "$u:$p" | chpasswd
        else
            echo -e "${RED}Erro ao criar usuÃ¡rio${NC}"
            sleep 2
            continue
        fi
        
        EXP="TESTE"
        EXPIRE_TIME=$(date -d "+$m minutes" +"%Y-%m-%d %H:%M")
        UUID="$EXPIRE_TIME"
        
        echo "$u:$p:$EXP:$l:$UUID" >> "$DB"
        
        clear
        echo -e "${BANNER_GREEN}âœ… USUÃRIO TESTE CRIADO${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "ğŸ‘¤ Login: ${GREEN}$u${NC}"
        echo -e "ğŸ”‘ Senha: ${YELLOW}$p${NC}"
        echo -e "ğŸ“¶ Limite: ${WHITE}$l conexÃµes${NC}"
        echo -e "â±ï¸  Validade: ${RED}$m minutos${NC}"
        echo -e "â° Expira em: ${YELLOW}$EXPIRE_TIME${NC}"
        echo -e "${YELLOW}âš ï¸  SerÃ¡ removido automaticamente apÃ³s expirar${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        
        sleep 3
        
        echo
        read -rp "Criar outro teste? (s/n): " resp
        [[ "$resp" != "s" ]] && break
    done
}

user_menu() {
    while true; do
        clear
        cleanup_expired_users

        echo -e "${CYAN}${BOLD}ğŸ‘¥ GERENCIAR USUÃRIOS${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}1)${NC} ${WHITE}Criar usuÃ¡rio${NC}"
        echo -e "${YELLOW}2)${NC} ${WHITE}Listar usuÃ¡rios${NC}"
        echo -e "${YELLOW}3)${NC} ${WHITE}Remover usuÃ¡rio${NC}"
        echo -e "${YELLOW}4)${NC} ${WHITE}Criar usuÃ¡rio TESTE${NC}"
        echo -e "${YELLOW}5)${NC} ${WHITE}Limpar usuÃ¡rios expirados${NC}"
        echo -e "${YELLOW}6)${NC} ${WHITE}Alterar limite${NC}"
        echo -e "${YELLOW}7)${NC} ${WHITE}Alterar senha${NC}"
        echo -e "${YELLOW}8)${NC} ${WHITE}Alterar data de expiraÃ§Ã£o${NC}"
        echo -e "${RED}0)${NC} ${WHITE}Voltar ao menu principal${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

        read -rp "OpÃ§Ã£o: " o
        [[ -z "$o" ]] && continue

        case "$o" in
            1) add_user ;;
            2) list_users ;;
            3) del_user ;;
            4) add_test_user ;;
            5)
                cleanup_expired_users
                echo
                echo -e "${GREEN}âœ… UsuÃ¡rios expirados removidos com sucesso${NC}"
                sleep 2
            ;;
            6) change_limit ;;
            7) change_password ;;
            8) change_expiration ;;
            0) break ;;
            *)
                echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}"
                sleep 1
            ;;
        esac
    done
}


# ================= PROTOCOLOS =================
protocol_menu() {
    while true; do
        clear
        echo -e "${CYAN}${BOLD}ğŸŒ PROTOCOLOS DE CONEXÃƒO${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}1)${NC} ${WHITE}WebSocket SSH   : $(service_status maritima-ws)${NC}"
        echo -e "${YELLOW}2)${NC} ${WHITE}XRAY REALITY    : $(service_status xray)${NC}"
        echo -e "${YELLOW}3)${NC} ${WHITE}BadVPN UDP      : $(service_status maritima-badvpn)${NC}"
        echo -e "${YELLOW}4)${NC} ${WHITE}HTTP Proxy      : $(service_status maritima-http)${NC}"
        echo -e "${YELLOW}5)${NC} ${WHITE}Gerar links REALITY${NC}"
        echo -e "${RED}0)${NC} ${WHITE}Voltar${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        
        read -rp "OpÃ§Ã£o: " p
        
        case $p in
            1) systemctl is-active maritima-ws &>/dev/null && systemctl stop maritima-ws || systemctl start maritima-ws ;;
            2) systemctl is-active xray &>/dev/null && systemctl stop xray || systemctl start xray ;;
            3) systemctl is-active maritima-badvpn &>/dev/null && systemctl stop maritima-badvpn || systemctl start maritima-badvpn ;;
            4) systemctl is-active maritima-http &>/dev/null && systemctl stop maritima-http || systemctl start maritima-http ;;
            5) reality_links ;;
            0) break ;;
            *) echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}"; sleep 1 ;;
        esac
        
        sleep 1
    done
}

reality_links() {
    cleanup_expired_users
    clear
    
    echo -e "${CYAN}${BOLD}ğŸ” LINKS XRAY REALITY${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    if [[ ! -f "$DB" ]] || [[ ! -s "$DB" ]]; then
        echo -e "${YELLOW}Nenhum usuÃ¡rio cadastrado${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        pause
        return
    fi
    
    IP=$(get_ip)
    
    while IFS= read -r line || [[ -n "$line" ]]; do
        [[ -z "$line" ]] && continue
        
        IFS=: read -r u p e l uuid <<< "$line"
        [[ -z "$u" ]] && continue
        
        DAYS_LEFT=$(calculate_days_left "$e")
        
        if [[ "$e" != "NUNCA" ]] && [[ "$e" != "TESTE" ]] && [[ "$DAYS_LEFT" == "0" ]]; then
            echo -e "\nâŒ ${RED}$u (EXPIRADO)${NC}"
        else
            echo -e "\nâœ… ${GREEN}$u${NC}"
            echo -e "ğŸ“… ${WHITE}$e${NC} ${GRAY}($DAYS_LEFT)${NC}"
            echo -e "${GRAY}vless://$uuid@$IP:443?type=tcp&security=reality&sni=www.google.com#MARITIMA-$u${NC}"
        fi
        
        echo -e "${LINE_COLOR}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        
    done < "$DB"
    
    pause
}

# ================= BANNER =================
banner_menu() {
    while true; do
        clear
        echo -e "${CYAN}${BOLD}ğŸ“¢ BANNER HTTP INJECTOR${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}1)${NC} ${WHITE}Ver banner${NC}"
        echo -e "${YELLOW}2)${NC} ${WHITE}Editar banner${NC}"
        echo -e "${YELLOW}3)${NC} ${WHITE}Limpar banner${NC}"
        echo -e "${RED}0)${NC} ${WHITE}Voltar${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        
        read -rp "OpÃ§Ã£o: " b
        
        case $b in
            1) clear; [[ -s "$BANNER" ]] && cat "$BANNER" || echo -e "${YELLOW}Banner vazio${NC}"; pause ;;
            2) nano "$BANNER" ;;
            3) > "$BANNER"; echo -e "${GREEN}âœ… Banner limpo${NC}"; sleep 1 ;;
            0) break ;;
            *) echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}"; sleep 1 ;;
        esac
    done
}

# ================= SPEED TEST =================
speed_test() {
    clear
    echo -e "${CYAN}ğŸš€ TESTE DE VELOCIDADE${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo

    if ! command -v speedtest &>/dev/null; then
        echo "Instalando speedtest..."
        apt update -y >/dev/null 2>&1
        apt install -y speedtest >/dev/null 2>&1
    fi

    speedtest --accept-license --accept-gdpr --format=human-readable

    echo
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    read -rp "ENTER para continuar..."
}


# ================= CRON JOB =================
setup_cron_job() {
    # Criar script de limpeza
    cat > /opt/maritima/cleanup_expired.sh << 'EOF'
#!/bin/bash
DB="/opt/maritima/users.db"
LOG="/opt/maritima/login_attempts.log"
TODAY=$(date +%Y-%m-%d)

[[ -f "$DB" ]] || exit 0

temp_file="${DB}.temp"
> "$temp_file"

while IFS=: read -r u p e l uuid; do
    [[ -z "$u" ]] && continue
    
    # TESTE com data/hora
    if [[ "$e" == "TESTE" ]] && [[ "$uuid" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}\ [0-9]{2}:[0-9]{2}$ ]]; then
        exp_seconds=$(date -d "$uuid" +%s 2>/dev/null || echo 0)
        now_seconds=$(date +%s)
        
        if [[ $exp_seconds -gt 0 ]] && [[ $now_seconds -ge $exp_seconds ]]; then
            echo "$(date '+%Y-%m-%d %H:%M:%S') - CRON: TESTE expirado $u" >> "$LOG"
            userdel "$u" 2>/dev/null
            pkill -u "$u" 2>/dev/null
            continue
        fi
    # Data normal
    elif [[ "$e" != "NUNCA" ]] && [[ "$e" != "TESTE" ]] && [[ "$e" < "$TODAY" ]]; then
        echo "$(date '+%Y-%m-%d %H:%M:%S') - CRON: Expirado $u ($e)" >> "$LOG"
        userdel "$u" 2>/dev/null
        pkill -u "$u" 2>/dev/null
        continue
    fi
    
    echo "$u:$p:$e:$l:$uuid" >> "$temp_file"
    
done < "$DB"

mv "$temp_file" "$DB" 2>/dev/null
EOF
    
    chmod +x /opt/maritima/cleanup_expired.sh
    
    # Adicionar ao crontab
    if ! grep -q "cleanup_expired.sh" /etc/crontab 2>/dev/null; then
        echo -e "\n# Maritima VPN - Limpeza automÃ¡tica" >> /etc/crontab
        echo "*/5 * * * * root /opt/maritima/cleanup_expired.sh" >> /etc/crontab
    fi
    
    systemctl restart cron 2>/dev/null || true
}

sync_users_now() {
    clear
    echo -e "${CYAN}ğŸ”„ SINCRONIZANDO USUÃRIOS${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    if [[ -x /opt/maritima/sync_users.sh ]]; then
        bash /opt/maritima/sync_users.sh
        echo
        echo -e "${GREEN}âœ… SincronizaÃ§Ã£o concluÃ­da${NC}"
    else
        echo -e "${RED}âŒ sync_users.sh nÃ£o encontrado${NC}"
    fi
    pause
}

restart_services() {
    clear
    tput civis

    fun_prog () {
        ${1} > /dev/null 2>&1 &
        while [ -d /proc/$! ]; do
            for i in / - \\ \|; do
                sleep 0.1
                printf "\r${YELLOW}%s${NC}" "$i"
            done
        done
        printf "\r${GREEN}OK${NC}\n"
    }

    echo -e "${CYAN}ğŸ”„ REINICIANDO SERVIÃ‡OS${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

    echo -ne "${YELLOW}OpenSSH... ${NC}"; fun_prog "service ssh restart"
    systemctl is-active maritima-ws &>/dev/null && echo -ne "${YELLOW}WebSocket... ${NC}" && fun_prog "systemctl restart maritima-ws"
    systemctl is-active maritima-http &>/dev/null && echo -ne "${YELLOW}HTTP Proxy... ${NC}" && fun_prog "systemctl restart maritima-http"
    systemctl is-active xray &>/dev/null && echo -ne "${YELLOW}XRAY... ${NC}" && fun_prog "systemctl restart xray"
    systemctl is-active maritima-badvpn &>/dev/null && echo -ne "${YELLOW}BadVPN... ${NC}" && fun_prog "systemctl restart maritima-badvpn"

    tput cnorm
    echo
    echo -e "${GREEN}âœ… ServiÃ§os reiniciados com sucesso${NC}"
    pause
}

reboot_server() {
    clear
    echo -e "${RED}âš ï¸ ATENÃ‡ÃƒO âš ï¸${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${YELLOW}O servidor serÃ¡ reiniciado AGORA.${NC}"
    echo
    read -rp "Confirmar reinÃ­cio? (s/N): " c
    if [[ "$c" =~ ^[sS]$ ]]; then
        echo -e "${RED}REINICIANDO...${NC}"
        sleep 2
        shutdown -r now
    else
        echo -e "${GREEN}Cancelado${NC}"
        sleep 1
    fi
}

maintenance_menu() {
    while true; do
        clear
        echo -e "${CYAN}ğŸ› ï¸ MENU SEGURANÃ‡A / MANUTENÃ‡ÃƒO${NC}"
        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

        echo -e "${YELLOW}1)${NC} ğŸ”„ Sincronizar usuÃ¡rios"
        echo -e "${YELLOW}2)${NC} ğŸ”§ Reiniciar serviÃ§os"
        echo -e "${YELLOW}3)${NC} ğŸ”´ Reiniciar servidor"
        echo -e "${YELLOW}4)${NC} ğŸš« Bloquear Torrent"
        echo -e "${YELLOW}5)${NC} ğŸ”“ Desbloquear Torrent"
        echo -e "${YELLOW}6)${NC} ğŸ›¡ï¸ Ativar Fail2Ban"
        echo -e "${YELLOW}7)${NC} âŒ Desativar Fail2Ban"
        echo -e "${YELLOW}8)${NC} ğŸ” Ver IPs Banidos"
        echo -e "${RED}0)${NC} Voltar"

        echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        read -rp "OpÃ§Ã£o: " op

        case $op in
            1) sync_users_now ;;
            2) restart_services ;;
            3) reboot_server ;;
            4) block_torrent ;;
            5) desblock_torrent ;;
            6) enable_fail2ban ;;
            7) disable_fail2ban ;;
            8) fail2ban_banned_ips ;;
            0) break ;;
            *) echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}"; sleep 1 ;;
        esac
    done
}


#BLOQUEAR TORRENT
block_torrent() {
    echo -e "${YELLOW}ğŸš« Bloqueando Torrent...${NC}"

    iptables -A FORWARD -m string --string "BitTorrent" --algo bm -j DROP
    iptables -A FORWARD -m string --string ".torrent" --algo bm -j DROP
    iptables -A FORWARD -m string --string "peer_id=" --algo bm -j DROP
    iptables -A FORWARD -m string --string "announce" --algo bm -j DROP
    iptables -A FORWARD -m string --string "info_hash" --algo bm -j DROP

    # PersistÃªncia
    if command -v iptables-save >/dev/null && [ -d /etc/iptables ]; then
        iptables-save > /etc/iptables/rules.v4
    fi

    echo -e "${GREEN}âœ… TORRENT BLOQUEADO COM SUCESSO${NC}"
    read -rp "ENTER para continuar..."
}


unblock_torrent() {
    clear
    echo -e "${YELLOW}âš ï¸ REMOVENDO BLOQUEIO DE TORRENT${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo

    iptables -F
    iptables-save > /etc/iptables/rules.v4 2>/dev/null || true

    echo
    echo -e "${GREEN}âœ… BLOQUEIO REMOVIDO${NC}"
    pause
}

torrent_status() {
    clear
    echo -e "${CYAN}ğŸ” STATUS DO BLOQUEIO DE TORRENT${NC}"
    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

    RULES=$(iptables -S FORWARD | grep -E "BitTorrent|\.torrent|peer_id=|announce|info_hash" | wc -l)

    if [[ "$RULES" -gt 0 ]]; then
        echo -e "${GREEN}ğŸš« Torrent: BLOQUEADO${NC}"
        echo ""
        echo -e "${YELLOW}Regras ativas:${NC} $RULES"
    else
        echo -e "${RED}âš ï¸ Torrent: LIBERADO${NC}"
        echo ""
        echo -e "${GRAY}Nenhuma regra de bloqueio encontrada${NC}"
    fi

    echo -e "${LINE_COLOR}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    read -rp "ENTER para voltar..."
}

                        #FAIL2BAN FUNÃ‡Ã•ES
fail2ban_status() {
    if systemctl is-active --quiet fail2ban; then
        echo -e "${GREEN}ğŸ›¡ï¸ Fail2Ban ATIVO${NC}"
    else
        echo -e "${RED}âŒ Fail2Ban DESATIVADO${NC}"
    fi
}

enable_fail2ban() {
    systemctl enable fail2ban
    systemctl start fail2ban
    echo -e "${GREEN}âœ… Fail2Ban ativado${NC}"
    read -rp "ENTER para continuar..."
}

disable_fail2ban() {
    systemctl stop fail2ban
    systemctl disable fail2ban
    echo -e "${YELLOW}âš ï¸ Fail2Ban desativado${NC}"
    read -rp "ENTER para continuar..."
}

fail2ban_banned_ips() {
    clear
    echo -e "${CYAN}ğŸš« IPs BANIDOS (SSH)${NC}"
    fail2ban-client status sshd | grep "Banned IP list"
    echo ""
    read -rp "ENTER para voltar..."
}


# ================= MENU PRINCIPAL =================
# Configurar cron job
setup_cron_job

while true; do
    clear
    
    echo -e "${BANNER_CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“${NC}"
    echo -e "${BANNER_CYAN}â”ƒ${NC}   ${BANNER_RED}ğŸ´â€â˜ ï¸${NC} ${BANNER_YELLOW}PAINEL VPN MARÃTIMA${NC} ${BANNER_RED}ğŸ´â€â˜ ï¸${NC}   ${BANNER_CYAN}â”ƒ${NC}"
    echo -e "${BANNER_CYAN}â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«${NC}"
    echo -e "${BANNER_CYAN}â”ƒ${NC} ${BANNER_GREEN}âš“ ATIVO${NC} ${BANNER_CYAN}â”‚${NC} ${BANNER_RED}â˜ ï¸ XRAY${NC} ${BANNER_CYAN}â”‚${NC} ${BANNER_PURPLE}ğŸ´â€â˜ ï¸ WEBSOCKET${NC} ${BANNER_CYAN}â”ƒ${NC}"
    echo -e "${BANNER_CYAN}â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›${NC}"
    echo -e "${NC}"
    echo -e "${BANNER_CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${YELLOW}1)${NC} ğŸ‘¥ UsuÃ¡rios"
    echo -e "${YELLOW}2)${NC} ğŸŒ Protocolos"
    echo -e "${YELLOW}3)${NC} ğŸ“Š Status VPS"
    echo -e "${YELLOW}4)${NC} ğŸ“¢ Banner"
    echo -e "${YELLOW}5)${NC} ğŸš€ Speed Test"
    echo -e "${YELLOW}6)${NC} ğŸ› ï¸ ManutenÃ§Ã£o / SeguranÃ§a"
    echo -e "${RED}0)${NC} âŒ Sair"

    echo -e "${BANNER_CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    read -rp "OpÃ§Ã£o: " op
    
    case $op in
    1) user_menu ;;
    2) protocol_menu ;;
    3) status_vps ;;
    4) banner_menu ;;
    5) speed_test ;;
    6) maintenance_menu ;;
    0) clear; exit ;;
    *) echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}"; sleep 1 ;;
esac

done
